name: Daily Automatic Release

on:
  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC
  schedule:
    - cron: '0 0 * * *'
  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–µ–ª–∏–∑—ã
    
    steps:
      - name: üì• –ó–∞–±—Ä–∞—Ç—å –∫–æ–¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –í—Å—è –∏—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–∏—Ç–æ–≤
      
      - name: üî¢ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤–µ—Ä—Å–∏—é (vMonth.Week.WeekDay)
        id: version
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ UTC
          MONTH=$(date -u +'%-m')        # –ù–æ–º–µ—Ä –º–µ—Å—è—Ü–∞ (1-12)
          WEEK=$(date -u +'%-U')         # –ù–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏ –≤ –≥–æ–¥—É (0-53)
          WEEKDAY=$(date -u +'%-u')      # –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (1-7, 1=–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
          
          VERSION="v${MONTH}.${WEEK}.${WEEKDAY}"
          echo "‚úÖ –í–µ—Ä—Å–∏—è: $VERSION"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: üìù –°–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        id: changelog
        run: |
          # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥
          if git describe --tags --abbrev=0 2>/dev/null; then
            LAST_TAG=$(git describe --tags --abbrev=0)
            echo "üìå –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥: $LAST_TAG"
            
            # –ö–æ–º–º–∏—Ç—ã —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–µ–≥–∞
            CHANGES=$(git log --oneline --pretty=format:"- %s (%h) [%an]" "${LAST_TAG}..HEAD" 2>/dev/null)
            
            if [ -z "$CHANGES" ]; then
              CHANGES="## üìã –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç\n\n–ù–µ—Ç –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–ª–∏–∑–∞."
            else
              CHANGES="## üìã –ù–æ–≤—ã–µ –∫–æ–º–º–∏—Ç—ã\n\n$CHANGES"
            fi
          else
            # –ü–µ—Ä–≤—ã–π —Ä–µ–ª–∏–∑ - –≤—Å–µ –∫–æ–º–º–∏—Ç—ã
            CHANGES="## üìã –í—Å–µ –∫–æ–º–º–∏—Ç—ã (–ø–µ—Ä–≤—ã–π —Ä–µ–ª–∏–∑)\n\n"
            CHANGES+=$(git log --oneline --pretty=format:"- %s (%h) [%an]" 2>/dev/null)
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          STATS="\n\n## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
          STATS+="- –í—Å–µ–≥–æ –∫–æ–º–º–∏—Ç–æ–≤: $(git rev-list --all --count 2>/dev/null || echo '0')\n"
          STATS+="- –í–µ—Ç–æ–∫: $(git branch -a | wc -l | xargs)\n"
          STATS+="- –ê–≤—Ç–æ—Ä–æ–≤: $(git log --format='%an' | sort -u | wc -l)\n"
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
          RELEASE_BODY="# üöÄ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Ä–µ–ª–∏–∑ ${{ steps.version.outputs.version }}\n\n"
          RELEASE_BODY+="**–î–∞—Ç–∞:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')\n\n"
          RELEASE_BODY+="${CHANGES}"
          RELEASE_BODY+="${STATS}\n\n---\n\n"
          RELEASE_BODY+="*ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ GitHub Actions*"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
          echo "$RELEASE_BODY" > release_notes.md
          
          # –í—ã–≤–æ–¥–∏–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          echo "üìÑ –°–æ–∑–¥–∞–Ω—ã –∑–∞–º–µ—Ç–∫–∏ —Ä–µ–ª–∏–∑–∞"
      
      - name: üè∑Ô∏è –°–æ–∑–¥–∞—Ç—å Git —Ç–µ–≥
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # –°–æ–∑–¥–∞–µ–º –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–≥
          git tag -a "${{ steps.version.outputs.version }}" \
                  -m "–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Ä–µ–ª–∏–∑ ${{ steps.version.outputs.version }}$(echo -e '\n\n–î–∞—Ç–∞: '$(date))"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–≥ –Ω–∞ GitHub
          git push origin "${{ steps.version.outputs.version }}"
      
      - name: üöÄ –°–æ–∑–¥–∞—Ç—å —Ä–µ–ª–∏–∑ –Ω–∞ GitHub
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "–†–µ–ª–∏–∑ ${{ steps.version.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: false
