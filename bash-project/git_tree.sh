#!/bin/bash

# ============================================
# –°–ö–†–ò–ü–¢ –î–õ–Ø –í–´–í–û–î–ê –î–ï–†–ï–í–ê –í–ï–¢–û–ö GIT –° –ö–û–ú–ú–ò–¢–ê–ú–ò
# –ê–≤—Ç–æ—Ä: [–í–∞—à–µ –ò–º—è]
# –î–∞—Ç–∞: $(date +%Y-%m-%d)
# ============================================

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–∞–ø–∫–∞ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º
check_git_repo() {
    if [ -d ".git" ]; then
        return 0  # true - —ç—Ç–æ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    else
        return 1  # false - –Ω–µ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
show_repo_info() {
    echo "========================================="
    echo "–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û GIT –†–ï–ü–û–ó–ò–¢–û–†–ò–ò"
    echo "========================================="
    
    # –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞
    CURRENT_BRANCH=$(git branch --show-current)
    echo "üìå –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"
    
    # URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    REPO_URL=$(git config --get remote.origin.url)
    if [ -n "$REPO_URL" ]; then
        echo "üåê URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: $REPO_URL"
    fi
    
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–º–∏—Ç–æ–≤
    COMMIT_COUNT=$(git rev-list --count HEAD)
    echo "üìä –í—Å–µ–≥–æ –∫–æ–º–º–∏—Ç–æ–≤: $COMMIT_COUNT"
    
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –¥–µ—Ä–µ–≤–∞ –≤–µ—Ç–æ–∫
show_branch_tree() {
    echo "========================================="
    echo "üå≥ –î–ï–†–ï–í–û –í–ï–¢–û–ö GIT"
    echo "========================================="
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–µ—Ç–∫–∏
    echo "üìã –í—Å–µ –≤–µ—Ç–∫–∏:"
    git branch -a
    
    echo ""
    echo "üîÑ –ì—Ä–∞—Ñ –∫–æ–º–º–∏—Ç–æ–≤:"
    
    # –í—ã–≤–æ–¥–∏–º –≥—Ä–∞—Ñ –∫–æ–º–º–∏—Ç–æ–≤
    git log --all --graph --oneline --decorate -20 2>/dev/null || \
    git log --all --graph --oneline --decorate 2>/dev/null
    
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–º–º–∏—Ç–æ–≤
show_recent_commits() {
    echo "========================================="
    echo "üìù –ü–û–°–õ–ï–î–ù–ò–ï –ö–û–ú–ú–ò–¢–´"
    echo "========================================="
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∫–æ–º–º–∏—Ç–æ–≤
    git log --oneline -10 2>/dev/null || \
    echo "–ù–µ—Ç –∫–æ–º–º–∏—Ç–æ–≤ –∏–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏"
    
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
show_repo_status() {
    echo "========================================="
    echo "üìä –°–¢–ê–¢–£–° –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø"
    echo "========================================="
    
    git status --short 2>/dev/null || \
    echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
    
    echo ""
}

# ============================================
# –û–°–ù–û–í–ù–ê–Ø –ü–†–û–ì–†–ê–ú–ú–ê
# ============================================

clear
echo "üîç –ü–†–û–í–ï–†–ö–ê GIT –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø"
echo "=========================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–¥–∞–Ω –ª–∏ –ø—É—Ç—å –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç
if [ -n "$1" ]; then
    TARGET_DIR="$1"
else
    TARGET_DIR="."
fi

echo "üìÇ –ü—Ä–æ–≤–µ—Ä—è–µ–º–∞—è –ø–∞–ø–∫–∞: $(realpath "$TARGET_DIR")"
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –ø–∞–ø–∫—É
cd "$TARGET_DIR" 2>/dev/null || {
    echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ –º–æ–≥—É –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É '$TARGET_DIR'"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–∞–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞."
    exit 1
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º
if check_git_repo; then
    echo "‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π!"
    echo ""
    
    # –í—ã–≤–æ–¥–∏–º –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    show_repo_info
    show_branch_tree
    show_recent_commits
    show_repo_status
    
    echo "========================================="
    echo "‚úÖ –°–ö–†–ò–ü–¢ –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!"
    echo "========================================="
    
else
    echo "‚ùå –í –≠–¢–û–ô –ü–ê–ü–ö–ï –ù–ï–¢ GIT –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø"
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "1. –ü–∞–ø–∫–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º"
    echo "2. –í—ã –Ω–µ –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
    echo "3. –ü–∞–ø–∫–∞ .git –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞"
    echo ""
    echo "–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:"
    echo "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥—Ä—É–≥—É—é –ø–∞–ø–∫—É: ./git_tree.sh /–ø—É—Ç—å/–∫/–ø–∞–ø–∫–µ"
    echo "2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ Git: git init"
    echo "3. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: git clone URL"
    
    exit 1
fi
