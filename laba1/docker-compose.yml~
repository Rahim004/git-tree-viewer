version: '3.8'

services:
  # Контейнер с базой данных MySQL
  db:
    image: mysql:8.0
    container_name: joomla_mysql
    restart: unless-stopped
    environment:
      # Критические переменные для инициализации БД. ЗАМЕНИТЕ 'strongpassword' на свой надежный пароль.
      MYSQL_ROOT_PASSWORD: strongpassword
      MYSQL_DATABASE: joomla_db
      MYSQL_USER: joomla_user
      MYSQL_PASSWORD: joomla_pass
    volumes:
      # Том для хранения всех файлов базы данных. Без него данные удалятся при остановке контейнера.
      - db_data:/var/lib/mysql
    networks:
      - joomla_network
    # Опционально: проверка готовности БД перед запуском других сервисов
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      timeout: 20s
      retries: 10

  # Контейнер с веб-сервером Apache и Joomla
  web:
    build:
      context: . # Указывает, что Dockerfile находится в текущей директории
      dockerfile: Dockerfile
    container_name: joomla_apache
    restart: unless-stopped
    ports:
      # Публикуем порт 80 контейнера на порт 8080 вашего компьютера.
      # Чтобы зайти на сайт, откройте в браузере: http://localhost:8080
      - "8080:80"
    environment:
      # Ссылаемся на переменные из сервиса 'db' для автоматической настройки Joomla
      JOOMLA_DB_HOST: db
      JOOMLA_DB_USER: joomla_user
      JOOMLA_DB_PASSWORD: joomla_pass
      JOOMLA_DB_NAME: joomla_db
    volumes:
      # Том для хранения файлов Joomla (темы, расширения, загруженные изображения).
      - joomla_data:/var/www/html
    depends_on:
      db:
        condition: service_healthy # Ждем, пока БД не станет полностью готова
    networks:
      - joomla_network

# Определение пользовательских томов для постоянного хранения данных
volumes:
  db_data:   # Том для данных MySQL
  joomla_data: # Том для файлов Joomla

# Определение внутренней сети для безопасного взаимодействия контейнеров
networks:
  joomla_network:
    driver: bridge
